<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an IT blog..."/>
  <meta name="keyword" content="v-vincen,v-vincen,livemylife,IT  blog,Blog"/>
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://yoursite-url/cn/一次线上环境非常规OOM问题的分析/">
  <title>
    
      一次线上环境非常规OOM问题的分析 - 兔子博客
    
  </title>
<meta name="generator" content="Hexo 5.4.2"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">张伟真的博客</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">首页</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              关于
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              归档
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              标签
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              分类
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>搜索</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/lml_bg.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/lml_bg.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/lml_bg.jpg'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/vincent-white.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#笔记" title="笔记">笔记</a>
              
              <a class="tag" href="/tags/#问题排查" title="问题排查">问题排查</a>
              
            </div>
            <h1>一次线上环境非常规OOM问题的分析</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by 张伟真 on
              2023-11-08
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">10</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">2.7k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h1 id="一次线上环境非常规OOM问题的分析"><a href="#一次线上环境非常规OOM问题的分析" class="headerlink" title="一次线上环境非常规OOM问题的分析"></a>一次线上环境非常规OOM问题的分析</h1><p>出现OOM的情况是这样的，在业务操作的高峰期，docker容器运行的6个实例，最多的时候可以一周有2-3天都会出现OOM，且一天最多出现3-4次的OOM。</p>
<p>在对这种OOM的dump文件初步分析之后发现，这不是之前出现过的，类似于用户查询某个列表数据，查询返回的数据量较大，且多个用户在同时查询，这种非常明显的，某个业务对象生成了很多，占用了很大的堆内存，导致的OOM的情况。</p>
<p>在出现OOM之后，会生成dump文件并保存，之后jvm进程终止。容器平台的健康检查，监控到服务异常后，会销毁异常的运行实例，并重新拉起健康的运行实例，即相当于重启服务，只不过是销毁掉原来的容器的实例，重新拉起一个。</p>
<p>排查jvm启动参数如下<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="title class_">Dfile</span>.encoding=<span class="variable constant_">UTF</span>-<span class="number">8</span> -server -<span class="title class_">Xms6144m</span> -<span class="title class_">Xmx6144m</span> -<span class="variable constant_">XX</span><span class="symbol">:NewRatio=</span><span class="number">1</span> -<span class="variable constant_">XX</span><span class="symbol">:MetaspaceSize=</span>128m -<span class="variable constant_">XX</span><span class="symbol">:MaxMetaspaceSize=</span>512m -<span class="variable constant_">XX</span><span class="symbol">:+AlwaysPreTouch</span> -<span class="variable constant_">XX</span><span class="symbol">:+UseConcMarkSweepGC</span> -<span class="variable constant_">XX</span><span class="symbol">:+CMSParallelInitialMarkEnabled</span> -<span class="variable constant_">XX</span><span class="symbol">:+CMSParallelRemarkEnabled</span> -<span class="variable constant_">XX</span><span class="symbol">:CMSInitiatingOccupancyFraction=</span><span class="number">75</span> -<span class="variable constant_">XX</span><span class="symbol">:+UseCMSInitiatingOccupancyOnly</span> -<span class="variable constant_">XX</span><span class="symbol">:+ExplicitGCInvokesConcurrent</span> -<span class="variable constant_">XX</span><span class="symbol">:+ParallelRefProcEnabled</span> -<span class="variable constant_">XX</span><span class="symbol">:MaxTenuringThreshold=</span><span class="number">3</span> -<span class="variable constant_">XX</span><span class="symbol">:+UnlockDiagnosticVMOptions</span> -<span class="variable constant_">XX</span><span class="symbol">:ParGCCardsPerStrideChunk=</span><span class="number">1024</span> -<span class="variable constant_">XX</span><span class="symbol">:ParallelGCThreads=</span><span class="number">4</span> -<span class="variable constant_">XX</span><span class="symbol">:-OmitStackTraceInFastThrow</span> -<span class="variable constant_">XX</span><span class="symbol">:+PrintGCDateStamps</span> -<span class="variable constant_">XX</span><span class="symbol">:+PrintGCTimeStamps</span> -<span class="variable constant_">XX</span><span class="symbol">:+PrintGCDetails</span> -<span class="variable constant_">XX</span><span class="symbol">:+PrintPromotionFailure</span> -<span class="variable constant_">XX</span><span class="symbol">:+PrintGCApplicationStoppedTime</span> -<span class="variable constant_">XX</span><span class="symbol">:-UseBiasedLocking</span> -<span class="variable constant_">XX</span><span class="symbol">:AutoBoxCacheMax=</span><span class="number">20000</span> -<span class="variable constant_">XX</span><span class="symbol">:+PrintCommandLineFlags</span> -<span class="variable constant_">XX</span><span class="symbol">:-UseGCLogFileRotation</span> -<span class="title class_">Xloggc</span><span class="symbol">:/jvmlog/settlement-service_java_gc_%p_%t</span>.log -<span class="variable constant_">XX</span><span class="symbol">:GCLogFileSize=</span>10M -<span class="variable constant_">XX</span><span class="symbol">:+CrashOnOutOfMemoryError</span> -<span class="variable constant_">XX</span><span class="symbol">:ErrorFile=/jvmlog/settlement-service_java_error_%p</span>.log -<span class="variable constant_">XX</span><span class="symbol">:+HeapDumpOnOutOfMemoryError</span> -<span class="variable constant_">XX</span><span class="symbol">:HeapDumpPath=/jvmlog/settlement-service</span>.hprof -<span class="title class_">Duser</span>.timezone=<span class="title class_">Asia</span>/<span class="title class_">Shanghai</span> -<span class="title class_">Djava</span>.rmi.server.hostname=<span class="number">127.0</span>.<span class="number">0.1</span> -<span class="title class_">Dcom</span>.sun.management.jmxremote.port=<span class="number">7001</span> -<span class="title class_">Dcom</span>.sun.management.jmxremote -<span class="title class_">Dcom</span>.sun.management.jmxremote.authenticate=<span class="literal">false</span> -<span class="title class_">Dcom</span>.sun.management.jmxremote.ssl=<span class="literal">false</span> -<span class="title class_">Djava</span>.net.preferIPv4Stack=<span class="literal">true</span> -<span class="title class_">Dfile</span>.encoding=<span class="variable constant_">UTF</span>-<span class="number">8</span> ...... -jar /settlement-service.jar</span><br></pre></td></tr></table></figure></p>
<p>注：因为会立即重新拉起应用，拉起的应用启动完成后，服务即可立即恢复正常，健康的可用实例数，就会马上又能满足设置的可用的健康实例数的阈值，所以告警发生和告警恢复，都是间隔很短，几乎是连续出现的。</p>
<p>拿到dump文件之后，使用Eclipse Memory Analyse Toll(MAT工具)进行分析，在MAT的Leak Suspects，也就是造成内存溢出的，可能的内存泄漏原因，预测时，无法给出明确的预测得到的原因。<br><img src="./oom问题分析1.png" alt="图片"><br>注：这个预测功能，是MAT工具的预测功能，相当于基于dump文件，自动识别出内存溢出的原因。</p>
<h2 id="1-SimpleDateFormat"><a href="#1-SimpleDateFormat" class="headerlink" title="1. SimpleDateFormat"></a>1. SimpleDateFormat</h2><p>进一步分析，可以看到，OOM报错，有明确的线程，如下图：</p>
<p>可以看到，这是一个定时任务，相关的业务处理的线程。</p>
<p>也就是说，最终造成OOM的，是这个线程。</p>
<p>可以进一步跟踪到，抛出OOM溢出的堆栈信息，根据堆栈信息找到对应的代码行如下<br><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dto.setDate((<span class="built_in">new</span> SimpleDateFormat(&quot;YYYY-MM-DD&quot;)).format(<span class="type">date</span>));</span><br></pre></td></tr></table></figure></p>
<p>SimpleDateFormat是线程不安全的，如果是共享操作，则可能在并发环境下，造成一些问题，但是这个代码，是在类的某个方法中，每次都是new，并不存在共享的问题。</p>
<p>这个线索，可能，可以进一步发掘，并得到问题的原因。但是在此处，线索中断了。</p>
<h2 id="2-偶然的发现，另外一个线索-Metaspace-OOM"><a href="#2-偶然的发现，另外一个线索-Metaspace-OOM" class="headerlink" title="2. 偶然的发现，另外一个线索 - Metaspace OOM"></a>2. 偶然的发现，另外一个线索 - Metaspace OOM</h2><p>在多次OOM的dump文件中，出现了一次非常明显的Metaspace OOM的提示，但是由于其他OOM并未明细报这个原因，所以一直没有考虑到Metaspace OOM这个方向，且根据上述分析得到的，OOM跟定时任务有关，而定时任务对应的业务逻辑，是有可能造成突然出现业务处理的高峰情况，即系统所有处理的数据量突然增大，系统资源的消耗会突然增加的情况，所以没有考虑到Metaspace OOM这种OOM的情况。<br><img src="./oom问题分析2.png" alt="图片"></p>
<p>多次OOM的dump文件的分析，发现一个比较明显的特点：线上环境的运行内存是6G，JVM参数也设置了，理论上可以用到6G，但是每次dump的文件大小，均只有1G左右，且dumo文件中，显示的对象的大小，也只有600M左右，远远小于6G。<br><img src="./oom问题分析3.png" alt="图片"><br>于是，带着这个疑问，进一步分析，发现发生这种OOM的，均是Metaspace OOM（结合dump情况的一些日志，一开始这些日志并没有拿到，且没有重视这块，一直在分析dump文件）<br><img src="./oom问题分析4.png" alt="图片"></p>
<h2 id="3-Metaspace-OOM的情况的确认"><a href="#3-Metaspace-OOM的情况的确认" class="headerlink" title="3. Metaspace OOM的情况的确认"></a>3. Metaspace OOM的情况的确认</h2><p>直接在生产环境，查看正常运行（此时还没发生OOM）情况下的Metaspace的使用情况，jvm进程的pid为1。<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">jmap</span> -heap <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">Attaching</span> to process ID <span class="number">1</span>, please wait...</span><br><span class="line"><span class="attribute">Debugger</span> attached successfully.</span><br><span class="line"><span class="attribute">Server</span> compiler detected.</span><br><span class="line"><span class="attribute">JVM</span> version is <span class="number">25</span>.<span class="number">322</span>-b06</span><br><span class="line"></span><br><span class="line"><span class="attribute">using</span> parallel threads in the new generation.</span><br><span class="line"><span class="attribute">using</span> thread-local object allocation.</span><br><span class="line"><span class="attribute">Concurrent</span> Mark-Sweep GC</span><br><span class="line"></span><br><span class="line"><span class="attribute">Heap</span> Configuration:</span><br><span class="line">   <span class="attribute">MinHeapFreeRatio</span>         = <span class="number">40</span></span><br><span class="line">   <span class="attribute">MaxHeapFreeRatio</span>         = <span class="number">70</span></span><br><span class="line">   <span class="attribute">MaxHeapSize</span>              = <span class="number">6442450944</span> (<span class="number">6144</span>.<span class="number">0</span>MB)</span><br><span class="line">   <span class="attribute">NewSize</span>                  = <span class="number">3221225472</span> (<span class="number">3072</span>.<span class="number">0</span>MB)</span><br><span class="line">   <span class="attribute">MaxNewSize</span>               = <span class="number">3221225472</span> (<span class="number">3072</span>.<span class="number">0</span>MB)</span><br><span class="line">   <span class="attribute">OldSize</span>                  = <span class="number">3221225472</span> (<span class="number">3072</span>.<span class="number">0</span>MB)</span><br><span class="line">   <span class="attribute">NewRatio</span>                 = <span class="number">1</span></span><br><span class="line">   <span class="attribute">SurvivorRatio</span>            = <span class="number">8</span></span><br><span class="line">   <span class="attribute">MetaspaceSize</span>            = <span class="number">134217728</span> (<span class="number">128</span>.<span class="number">0</span>MB)</span><br><span class="line">   <span class="attribute">CompressedClassSpaceSize</span> = <span class="number">528482304</span> (<span class="number">504</span>.<span class="number">0</span>MB)</span><br><span class="line">   <span class="attribute">MaxMetaspaceSize</span>         = <span class="number">536870912</span> (<span class="number">512</span>.<span class="number">0</span>MB)</span><br><span class="line">   <span class="attribute">G1HeapRegionSize</span>         = <span class="number">0</span> (<span class="number">0</span>.<span class="number">0</span>MB)</span><br><span class="line"></span><br><span class="line"><span class="attribute">Heap</span> Usage:</span><br><span class="line"><span class="attribute">New</span> Generation (Eden + <span class="number">1</span> Survivor Space):</span><br><span class="line">   <span class="attribute">capacity</span> = <span class="number">2899116032</span> (<span class="number">2764</span>.<span class="number">8125</span>MB)</span><br><span class="line">   <span class="attribute">used</span>     = <span class="number">2539904120</span> (<span class="number">2422</span>.<span class="number">241325378418</span>MB)</span><br><span class="line">   <span class="attribute">free</span>     = <span class="number">359211912</span> (<span class="number">342</span>.<span class="number">57117462158203</span>MB)</span><br><span class="line">   <span class="attribute">87</span>.<span class="number">60960554751608</span>% used</span><br><span class="line"><span class="attribute">Eden</span> Space:</span><br><span class="line">   <span class="attribute">capacity</span> = <span class="number">2577006592</span> (<span class="number">2457</span>.<span class="number">625</span>MB)</span><br><span class="line">   <span class="attribute">used</span>     = <span class="number">2535723800</span> (<span class="number">2418</span>.<span class="number">2546615600586</span>MB)</span><br><span class="line">   <span class="attribute">free</span>     = <span class="number">41282792</span> (<span class="number">39</span>.<span class="number">370338439941406</span>MB)</span><br><span class="line">   <span class="attribute">98</span>.<span class="number">39803312385163</span>% used</span><br><span class="line"><span class="attribute">From</span> Space:</span><br><span class="line">   <span class="attribute">capacity</span> = <span class="number">322109440</span> (<span class="number">307</span>.<span class="number">1875</span>MB)</span><br><span class="line">   <span class="attribute">used</span>     = <span class="number">4180320</span> (<span class="number">3</span>.<span class="number">986663818359375</span>MB)</span><br><span class="line">   <span class="attribute">free</span>     = <span class="number">317929120</span> (<span class="number">303</span>.<span class="number">2008361816406</span>MB)</span><br><span class="line">   <span class="attribute">1</span>.<span class="number">2977949357833163</span>% used</span><br><span class="line"><span class="attribute">To</span> Space:</span><br><span class="line">   <span class="attribute">capacity</span> = <span class="number">322109440</span> (<span class="number">307</span>.<span class="number">1875</span>MB)</span><br><span class="line">   <span class="attribute">used</span>     = <span class="number">0</span> (<span class="number">0</span>.<span class="number">0</span>MB)</span><br><span class="line">   <span class="attribute">free</span>     = <span class="number">322109440</span> (<span class="number">307</span>.<span class="number">1875</span>MB)</span><br><span class="line">   <span class="attribute">0</span>.<span class="number">0</span>% used</span><br><span class="line"><span class="attribute">concurrent</span> mark-sweep generation:</span><br><span class="line">   <span class="attribute">capacity</span> = <span class="number">3221225472</span> (<span class="number">3072</span>.<span class="number">0</span>MB)</span><br><span class="line">   <span class="attribute">used</span>     = <span class="number">1353705816</span> (<span class="number">1290</span>.<span class="number">9944686889648</span>MB)</span><br><span class="line">   <span class="attribute">free</span>     = <span class="number">1867519656</span> (<span class="number">1781</span>.<span class="number">0055313110352</span>MB)</span><br><span class="line">   <span class="attribute">42</span>.<span class="number">024559527635574</span>% used</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>可以看到，jvm的可用Mestaspace空间最大值，是512M<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># jstat -gcutil 1 | awk <span class="string">&#x27;&#123;print($5)&#125;&#x27;</span> </span></span><br><span class="line">M</span><br><span class="line"><span class="number">91.59</span></span><br><span class="line">/ <span class="meta"># </span></span><br></pre></td></tr></table></figure></p>
<p>打印了当前Metaspace的使用率，可以看到，在服务正常运行的情况下，Metaspace的使用率在90%以上，的确是使用了较多的元数据空间。</p>
<p>进一步，在DEV环境，重新发布应用，在应用刚开始运行的时刻，就用上述命令，打印Metaspace的使用情况，发现也是使用接近90%。</p>
<p>那么，上述的分析，可以确定，发生了这么多次的OOM，很可能大部分情况都是Metaspace OOM。</p>
<p>正式因为OOM是Metaspace OOM，所以每次dump的内存镜像文件，其文件大小，以及其中所显示的对象占用的内存大小，才远远小于JVM可用的内存容量。</p>
<h2 id="4-Metaspace-OOM-产生原因的进一步深入分析"><a href="#4-Metaspace-OOM-产生原因的进一步深入分析" class="headerlink" title="4. Metaspace OOM 产生原因的进一步深入分析"></a>4. Metaspace OOM 产生原因的进一步深入分析</h2><p>Metaspace不足，那么说明加载的class类过多，每一个class类，由对应的classloader加载到jvm中时，都会占用Metaspace。注意一个class，即使会new多个对象实例，并不会再增加Metaspace的使用。new的对象实例，占用的是heap space 堆空间。</p>
<p>虽然Metaspace加载了较多的对象，使用的较多，但是若能够及时的进行内存回收，释放空间，也不会导致OOM。</p>
<p>class类的元信息，由classloader加载到jvm之后，没法得到及时、有效的释放，那么是谁持有了这些class类的元数据信息呢，那就是这些classloader。所以可以进一步推断出，classloader要么是太多（各种各样不同的classloader），要么是单个classloader加载的类（不同的class）太多。</p>
<p>使用阿里Arthas工具，打印classloader信息：<br><img src="./oom问题分析5.png" alt="图片"></p>
<p>可以看到，类加载器classloader，最多的，是DeletgatingClassLoader。DeletgatingClassLoader是跟反射相关的classloader。</p>
<p>使用MAT工具，查看classloader的具体的信息<br><img src="./oom问题分析6.png" alt="图片"><br>可以看到，有非常多的，sun.reflect.DelegatingClassLoader的classloader的对象实例。<br>结合前面得到的结论，发生OOM的情况，大部分是定时任务运行触发的，在定时任务拉起处理线程，进行业务处理时，存在大量使用了反射的情况，因此产生了较多的classloader，且这种反射所加载的对象，没办法重用classloader，所有classloader的数量也很庞大。</p>
<ol>
<li>在MAT中，查看某一个classloader所引用的对象的引用树</li>
<li>定位到CachedIntrospectionResults对象，这是一个Spring中，BeanUtils拷贝bean的方法相关的类。</li>
<li>随机点开一些classloader，查看其引用树，还有一些是json序列化相关的，这里其实底层也是用到了反射</li>
<li>关于反射，导致的OOM问题，网上有一篇文章，提到了如下内容<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当使用JavaBean的内省时，使用Introspector，jdk会自动缓存内省信息（BeanInfo），这一点是可以理解的，毕竟内省通过反射的代价是高昂的。当ClassLoader关闭时，Introspector的缓存持有BeanInfo的信息，而BeanInfo持有<span class="keyword">Class</span>的强引用，这会导致ClassLoader和它引用的<span class="keyword">Class</span>等对象不能被回收。</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>简单点说，就是在反射处理时，为了优化性能，会使用缓存。但是这会带来副作用，有可能会导致OOM，原因是：当ClassLoader使用完关闭时，缓存仍然持有Class的强引用，这会导致ClassLoader和它引用的Class等对象不能被回收。</p>
<p>至此总结如下：<br>因为很多代码处理逻辑的底层，使用了反射（包括上面提到的spring的BeanUtils的拷贝对象，json的序列化），而反射在大量使用时，因为使用了缓存的原因，导致ClassLoader和它引用的Class等对象不能被回收，进一步导致了元数据空间Metaspace被使用完，在总的已使用内存，远小于JVM的总的可用内存的情况下，发生了Metaspace的OOM。</p>
<h2 id="5-优化方案"><a href="#5-优化方案" class="headerlink" title="5. 优化方案"></a>5. 优化方案</h2><ol>
<li><p>优化业务处理逻辑，避免瞬间的业务处理量急剧增加（这里除了数据量的因素，还需要考虑业务处理逻辑的的性能消耗的维度），或者才有简单直接的方法————减少每次处理的数据量，分多次处理</p>
</li>
<li><p>减少代码中，使用反射的情况，或者对反射进行优化；</p>
</li>
<li><p>对服务进行拆分，拆分为多个服务中心，减少每个运行的JVM中的加载的对象元数据量的大小；</p>
</li>
<li><p>增加jvm运行参数中，优化MaxMetaspaceSize，增加其大小，或者直接去掉该参数，即去掉最大可用元数据空间的限制。</p>
</li>
</ol>
<p>其实，这也从另一个方面说明了，jvm参数在大多数情况下，不需要人为设定（非必需不优化原则，防止过度优化、提前优化），由系统自己确定最优的参数即可，这在jdk的高版本中，尤为明显。</p>
<p>参考资料：<br>1、java内省优化工具类BeanUtils（优化内省并防止内存泄漏）<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/220512f4b2d4">https://www.jianshu.com/p/220512f4b2d4</a><br>2、Java元空间Metaspace内存溢出排查方法总结<br><a target="_blank" rel="noopener" href="http://javakk.com/790.html">http://javakk.com/790.html</a><br>3、大量DelegatingClassLoader类加载器，导致Perm区溢出<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/hellozhxy/article/details/80559419">https://blog.csdn.net/hellozhxy/article/details/80559419</a><br>4、记一次Metaspace OutOfMemoryError问题排查记录<br><a target="_blank" rel="noopener" href="https://baijiahao.baidu.com/s?id=1737010123483039347">https://baijiahao.baidu.com/s?id=1737010123483039347</a><br>5、一次由热部署导致的 OOM 排查经历<br><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzU4MDUyMDQyNQ==&amp;mid=2247514041&amp;idx=1&amp;sn=bad70891502ce76027063db9b687c72b&amp;chksm=fd57673fca20ee297818d44b5c55ac487992a8733de96500cd334ddced62bbb80ef23dfac026&amp;mpshare=1&amp;scene=24&amp;srcid=1108xEPyLzfctRJlxjZ1NJvI&amp;sharer_shareinfo=497fd1c4869477c567ef40efe77d921b&amp;sharer_shareinfo_first=497fd1c4869477c567ef40efe77d921b#rd">http://mp.weixin.qq.com/s?__biz=MzU4MDUyMDQyNQ==&amp;mid=2247514041&amp;idx=1&amp;sn=bad70891502ce76027063db9b687c72b&amp;chksm=fd57673fca20ee297818d44b5c55ac487992a8733de96500cd334ddced62bbb80ef23dfac026&amp;mpshare=1&amp;scene=24&amp;srcid=1108xEPyLzfctRJlxjZ1NJvI&amp;sharer_shareinfo=497fd1c4869477c567ef40efe77d921b&amp;sharer_shareinfo_first=497fd1c4869477c567ef40efe77d921b#rd</a></p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/cn/微服务下解决子服务本开发服务调用问题/" data-toggle="tooltip" data-placement="top" title="微服务下解决子服务本地开发服务调用问题">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/cn/一次K8S健康检查失败/" data-toggle="tooltip" data-placement="top" title="记一次K8S健康检查失败">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      如果您喜欢此博客或发现它对您有用，则欢迎对此发表评论。 也欢迎您共享此博客，以便更多人可以参与。 如果博客中使用的图像侵犯了您的版权，请与作者联系以将其删除。 谢谢 ！
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=一次线上环境非常规OOM问题的分析&body=Hi,I found this website and thought you might like it http://yoursite-url/cn/一次线上环境非常规OOM问题的分析/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '',
      clientSecret: '',
      repo: '',
      owner: '',
      admin: '',
      id: 'Wed Nov 08 2023 14:02:07 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">目录</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83%E9%9D%9E%E5%B8%B8%E8%A7%84OOM%E9%97%AE%E9%A2%98%E7%9A%84%E5%88%86%E6%9E%90"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">一次线上环境非常规OOM问题的分析</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-SimpleDateFormat"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">1. SimpleDateFormat</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#2-%E5%81%B6%E7%84%B6%E7%9A%84%E5%8F%91%E7%8E%B0%EF%BC%8C%E5%8F%A6%E5%A4%96%E4%B8%80%E4%B8%AA%E7%BA%BF%E7%B4%A2-Metaspace-OOM"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">2. 偶然的发现，另外一个线索 - Metaspace OOM</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#3-Metaspace-OOM%E7%9A%84%E6%83%85%E5%86%B5%E7%9A%84%E7%A1%AE%E8%AE%A4"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">3. Metaspace OOM的情况的确认</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#4-Metaspace-OOM-%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0%E7%9A%84%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">4. Metaspace OOM 产生原因的进一步深入分析</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#5-%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">5. 优化方案</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">特色标签</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#笔记" title="笔记">笔记</a>
            
            <a class="tag" href="/tags/#问题排查" title="问题排查">问题排查</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>链友</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://hexo.io/" target="_blank">Hexo</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/zhang-weizhen">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          张伟真
          2025
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://yoursite-url/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="搜索..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
