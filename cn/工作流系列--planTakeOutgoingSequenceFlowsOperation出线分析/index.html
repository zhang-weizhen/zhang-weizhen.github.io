<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an IT blog..."/>
  <meta name="keyword" content="v-vincen,v-vincen,livemylife,IT  blog,Blog"/>
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://yoursite-url/cn/工作流系列--planTakeOutgoingSequenceFlowsOperation出线分析/">
  <title>
    
      工作流系列--TakeOutgoingSequenceFlowsOperation出线分析 - 兔子博客
    
  </title>
<meta name="generator" content="Hexo 5.4.2"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">张伟真的博客</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">首页</a>
          </li>

          
          
          
          
          <li>
            <a href="/archive/">
              
              归档
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/about/">
              
              关于
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              分类
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              标签
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>搜索</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/lml_bg.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/lml_bg.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/lml_bg.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/lml_bg.jpg'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/vincent-white.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#笔记" title="笔记">笔记</a>
              
              <a class="tag" href="/tags/#工作流" title="工作流">工作流</a>
              
            </div>
            <h1>工作流系列--TakeOutgoingSequenceFlowsOperation出线分析</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by 张伟真 on
              2024-11-09
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">10</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">2.4k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h1>工作流系列–planTakeOutgoingSequenceFlowsOperation出线分析</h1>
<h2 id="一、-分析">一、 分析</h2>
<p>这节我们来看看planTakeOutgoingSequenceFlowsOperation出线究竟做来啥<br>
省流总结直接看文档末尾<br>
<img src="./%E5%87%BA%E7%BA%BF%E5%88%86%E6%9E%90.png" alt="出线分析"><br>
源码中看出这里发出去TakeOutgoingSequenceFlowsOperation的命令,来看下命令里面怎么处理</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       FlowElement currentFlowElement = getCurrentFlowElement(<span class="keyword">execution</span>);</span><br><span class="line">	</span><br><span class="line">       <span class="comment">// Compensation check  补偿检查</span></span><br><span class="line">       <span class="keyword">if</span> ((currentFlowElement <span class="keyword">instanceof</span> Activity)</span><br><span class="line">               &amp;&amp; (((Activity) currentFlowElement)).isForCompensation()) &#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">      * If the current flow element is part of a compensation, we don&#x27;t always</span></span><br><span class="line"><span class="comment">      * want to follow the regular rules of leaving an activity.</span></span><br><span class="line"><span class="comment">      * More specifically, if there are no outgoing sequenceflow, we simply must stop</span></span><br><span class="line"><span class="comment">      * the execution there and don&#x27;t go up in the scopes as we usually do</span></span><br><span class="line"><span class="comment">      * to find the outgoing sequenceflow</span></span><br><span class="line"><span class="comment">   * 如果当前流程元素是补偿的一部分，我们并不总是希望遵循离开活动的常规规则。</span></span><br><span class="line"><span class="comment">   * 更具体地说，如果没有传出序列流，我们只需在那里停止执行，而不是像我们通常做的那样在范围内找到传出序列流</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"></span><br><span class="line">           cleanupCompensation();</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// When leaving the current activity, we need to delete any related execution (eg active boundary events)</span></span><br><span class="line">       <span class="comment">// 当离开当前活动时，我们需要删除任何相关的执行（例如活动边界事件）</span></span><br><span class="line">	cleanupExecutions(currentFlowElement);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (currentFlowElement <span class="keyword">instanceof</span> FlowNode) &#123;</span><br><span class="line">           handleFlowNode((FlowNode) currentFlowElement);</span><br><span class="line">       &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(currentFlowElement <span class="keyword">instanceof</span> SequenceFlow)</span> </span>&#123;</span><br><span class="line">           handleSequenceFlow();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>上面做的主要事项<br>
检查是否补偿节点:<br>
是：的话则到这里停止执行，做清理操作并返回<br>
否： 1、离开当前活动时候，要删除任务相关的执行（例如活动边界事件）<br>
2、若是个节点：执行handleFlowNode操作<br>
3、若是个线条：执行handleSequenceFlow操作。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">cleanupExecutions</span><span class="params">(FlowElement currentFlowElement)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">execution</span>.getParentId() != <span class="keyword">null</span> &amp;&amp; <span class="keyword">execution</span>.isScope()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the execution is a scope (and not a process instance), the scope must first be</span></span><br><span class="line">            <span class="comment">// destroyed before we can continue and follow the sequence flow</span></span><br><span class="line"></span><br><span class="line">            Context.getAgenda().planDestroyScopeOperation(<span class="keyword">execution</span>);</span><br><span class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(currentFlowElement <span class="keyword">instanceof</span> Activity)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the current activity is an activity, we need to remove any currently active boundary events</span></span><br><span class="line"></span><br><span class="line">            Activity activity = (Activity) currentFlowElement;</span><br><span class="line">            <span class="keyword">if</span> (CollectionUtil.isNotEmpty(activity.getBoundaryEvents())) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Cancel events are not removed</span></span><br><span class="line">                List&lt;String&gt; notToDeleteEvents = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                <span class="keyword">for</span> (BoundaryEvent event : activity.getBoundaryEvents()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (CollectionUtil.isNotEmpty(event.getEventDefinitions()) &amp;&amp;</span><br><span class="line">                            event.getEventDefinitions().get(<span class="number">0</span>) <span class="keyword">instanceof</span> CancelEventDefinition) &#123;</span><br><span class="line">                        notToDeleteEvents.add(event.getId());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Delete all child executions</span></span><br><span class="line">                Collection&lt;ExecutionEntity&gt; childExecutions = commandContext.getExecutionEntityManager().findChildExecutionsByParentExecutionId(<span class="keyword">execution</span>.getId());</span><br><span class="line">                <span class="keyword">for</span> (ExecutionEntity childExecution : childExecutions) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (childExecution.getCurrentFlowElement() == <span class="keyword">null</span> || !notToDeleteEvents.contains(childExecution.getCurrentFlowElement().getId())) &#123;</span><br><span class="line">                        commandContext.getExecutionEntityManager().deleteExecutionAndRelatedData(childExecution,</span><br><span class="line">                                                                                                 <span class="keyword">null</span>,</span><br><span class="line">                                                                                                 <span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>看看cleanupExecutions主要做了啥呢<br>
if. 当是一个父元素而非流程实例时候：则先销毁该元素范围内的，通过：Context.getAgenda().planDestroyScopeOperation(execution);<br>
else 若是一个任务节点：更新(ACT_HI_ACTINST表)实例历史数据并删除子执行的相关数据（但不删除定义了边界取消事件的节点）<br>
删除的子执行的数据有:<br>
1.删除ACT_RU_IDENTITYLINK<br>
2.删除ACT_RU_VARIABLE<br>
3.删除ACT_GE_BYTEARRAY<br>
4.删除ACT_RU_EXECUTION<br>
主要是一些运行中的数据</p>
<p>下一步handleFlowNode</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="built_in">void</span> <span class="title function_">handleFlowNode</span>(<span class="params"><span class="title class_">FlowNode</span> flowNode</span>) &#123;</span><br><span class="line">       <span class="title function_">handleActivityEnd</span>(flowNode);</span><br><span class="line">       <span class="keyword">if</span> (flowNode.<span class="title function_">getParentContainer</span>() != <span class="literal">null</span></span><br><span class="line">               &amp;&amp; flowNode.<span class="title function_">getParentContainer</span>() <span class="keyword">instanceof</span> <span class="title class_">AdhocSubProcess</span>) &#123;</span><br><span class="line">           <span class="title function_">handleAdhocSubProcess</span>(flowNode);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="title function_">leaveFlowNode</span>(flowNode);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里比较简单<br>
1、记录结束时间等信息及监听器的触发<br>
2、若是特别子流程则处理, 否则：离开节点<br>
子流程怎么处理呢</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">handleAdhocSubProcess</span><span class="params">(FlowNode flowNode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> completeAdhocSubProcess = <span class="keyword">false</span>;</span><br><span class="line">        AdhocSubProcess adhocSubProcess = (AdhocSubProcess) flowNode.getParentContainer();</span><br><span class="line">        <span class="keyword">if</span> (adhocSubProcess.getCompletionCondition() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Expression expression = Context.getProcessEngineConfiguration().getExpressionManager().createExpression(adhocSubProcess.getCompletionCondition());</span><br><span class="line">            Condition condition = <span class="keyword">new</span> UelExpressionCondition(expression);</span><br><span class="line">            <span class="keyword">if</span> (condition.evaluate(adhocSubProcess.getId(),</span><br><span class="line">                                   <span class="keyword">execution</span>)) &#123;</span><br><span class="line">                completeAdhocSubProcess = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (flowNode.getOutgoingFlows().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            leaveFlowNode(flowNode);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commandContext.getExecutionEntityManager().deleteExecutionAndRelatedData(<span class="keyword">execution</span>,</span><br><span class="line">                                                                                     <span class="keyword">null</span>,</span><br><span class="line">                                                                                     <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (completeAdhocSubProcess) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> endAdhocSubProcess = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (!adhocSubProcess.isCancelRemainingInstances()) &#123;</span><br><span class="line">                List&lt;ExecutionEntity&gt; childExecutions = commandContext.getExecutionEntityManager().findChildExecutionsByParentExecutionId(<span class="keyword">execution</span>.getParentId());</span><br><span class="line">                <span class="keyword">for</span> (ExecutionEntity executionEntity : childExecutions) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!executionEntity.getId().equals(<span class="keyword">execution</span>.getId())) &#123;</span><br><span class="line">                        endAdhocSubProcess = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (endAdhocSubProcess) &#123;</span><br><span class="line">                Context.getAgenda().planEndExecutionOperation(<span class="keyword">execution</span>.getParent());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如果有完成条件、判断条件是否满足<br>
若出线大于0则执行出线leaveFlowNode()<br>
出线为0则：执行删除执行相关数据操作(也就是可能是特殊子流程的最后一个节点了)<br>
若满足完成条件,则判断：<br>
若特殊子流程不取消剩余实例：<br>
判断是否结束特殊子流程: 查找是否还有其他的子执行，若是则不结束;<br>
若结束则:Context.getAgenda().planEndExecutionOperation(execution.getParent())</p>
<p>再看看leaveFlowNode</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">leaveFlowNode</span><span class="params">(FlowNode flowNode)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        logger.debug(<span class="string">&quot;Leaving flow node &#123;&#125; with id &#x27;&#123;&#125;&#x27; by following it&#x27;s &#123;&#125; outgoing sequenceflow&quot;</span>,</span><br><span class="line">                     flowNode.getClass(),</span><br><span class="line">                     flowNode.getId(),</span><br><span class="line">                     flowNode.getOutgoingFlows().size());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get default sequence flow (if set) 获取默认序列流（如果设置）</span></span><br><span class="line">        String defaultSequenceFlowId = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (flowNode <span class="keyword">instanceof</span> Activity) &#123;</span><br><span class="line">            defaultSequenceFlowId = ((Activity) flowNode).getDefaultFlow();</span><br><span class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(flowNode <span class="keyword">instanceof</span> Gateway)</span> </span>&#123;</span><br><span class="line">            defaultSequenceFlowId = ((Gateway) flowNode).getDefaultFlow();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Determine which sequence flows can be used for leaving 确定哪些序列流可用于离开</span></span><br><span class="line">        List&lt;SequenceFlow&gt; outgoingSequenceFlows = <span class="keyword">new</span> ArrayList&lt;SequenceFlow&gt;();</span><br><span class="line">		<span class="comment">//循环获取所有出线的表达式并计算</span></span><br><span class="line">        <span class="keyword">for</span> (SequenceFlow sequenceFlow : flowNode.getOutgoingFlows()) &#123;</span><br><span class="line">			<span class="comment">//获取跳过表达式</span></span><br><span class="line">            String skipExpressionString = sequenceFlow.getSkipExpression();</span><br><span class="line">			<span class="comment">//_ACTIVITI_SKIP_EXPRESSION_ENABLED 全局变量是否开启跳过表达式</span></span><br><span class="line">			<span class="comment">//未开启跳过表达式则计算</span></span><br><span class="line">            <span class="keyword">if</span> (!SkipExpressionUtil.isSkipExpressionEnabled(<span class="keyword">execution</span>,skipExpressionString)) &#123;</span><br><span class="line">			<span class="comment">//忽略计算条件(false)或者（条件表达式计算为true且（默认出现为null或非默认出线）</span></span><br><span class="line">                <span class="keyword">if</span> (!evaluateConditions|| (evaluateConditions &amp;&amp; ConditionUtil.hasTrueCondition(sequenceFlow,</span><br><span class="line">                                                                                 <span class="keyword">execution</span>) &amp;&amp; (defaultSequenceFlowId == <span class="keyword">null</span> || !defaultSequenceFlowId.equals(sequenceFlow.getId())))) &#123;</span><br><span class="line">                    outgoingSequenceFlows.add(sequenceFlow);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (flowNode.getOutgoingFlows().size() == <span class="number">1</span> || SkipExpressionUtil.shouldSkipFlowElement(commandContext,</span><br><span class="line">                                                                                                           <span class="keyword">execution</span>,</span><br><span class="line">                                                                                                           skipExpressionString)) &#123;</span><br><span class="line">                <span class="comment">// The &#x27;skip&#x27; for a sequence flow means that we skip the condition, not the sequence flow.</span></span><br><span class="line">				<span class="comment">//序列流的“跳过”意味着我们跳过条件，而不是序列流。</span></span><br><span class="line">				<span class="comment">//出线为1或者计算应该跳过流元素</span></span><br><span class="line">                outgoingSequenceFlows.add(sequenceFlow);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if there is a default sequence flow 检查是否有默认的序列流，默认的加入出线集合</span></span><br><span class="line">		<span class="comment">// 出线为0且需计算条件（找出默认出线）</span></span><br><span class="line">        <span class="keyword">if</span> (outgoingSequenceFlows.size() == <span class="number">0</span> &amp;&amp; evaluateConditions) &#123; <span class="comment">// The elements that set this to false also have no support for default sequence flow</span></span><br><span class="line">            <span class="keyword">if</span> (defaultSequenceFlowId != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (SequenceFlow sequenceFlow : flowNode.getOutgoingFlows()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (defaultSequenceFlowId.equals(sequenceFlow.getId())) &#123;</span><br><span class="line">                        outgoingSequenceFlows.add(sequenceFlow);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// No outgoing found. Ending the execution 没有发现出线。结束执行</span></span><br><span class="line">        <span class="keyword">if</span> (outgoingSequenceFlows.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (flowNode.getOutgoingFlows() == <span class="keyword">null</span> || flowNode.getOutgoingFlows().size() == <span class="number">0</span>) &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;No outgoing sequence flow found for flow node &#x27;&#123;&#125;&#x27;.&quot;</span>,</span><br><span class="line">                             flowNode.getId());</span><br><span class="line">                Context.getAgenda().planEndExecutionOperation(<span class="keyword">execution</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ActivitiException(<span class="string">&quot;No outgoing sequence flow of element &#x27;&quot;</span> + flowNode.getId() + <span class="string">&quot;&#x27; could be selected for continuing the process&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Leave, and reuse the incoming sequence flow, make executions for all the others (if applicable)</span></span><br><span class="line"></span><br><span class="line">            ExecutionEntityManager executionEntityManager = commandContext.getExecutionEntityManager();</span><br><span class="line">            List&lt;ExecutionEntity&gt; outgoingExecutions = <span class="keyword">new</span> ArrayList&lt;ExecutionEntity&gt;(flowNode.getOutgoingFlows().size());</span><br><span class="line"></span><br><span class="line">            SequenceFlow sequenceFlow = outgoingSequenceFlows.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Reuse existing one</span></span><br><span class="line">            <span class="keyword">execution</span>.setCurrentFlowElement(sequenceFlow);</span><br><span class="line">            <span class="keyword">execution</span>.setActive(<span class="keyword">true</span>);</span><br><span class="line">            outgoingExecutions.add((ExecutionEntity) <span class="keyword">execution</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Executions for all the other one</span></span><br><span class="line">			<span class="comment">//大于一个出线，则为所有的出线入库（并行网关等...）</span></span><br><span class="line">            <span class="keyword">if</span> (outgoingSequenceFlows.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; outgoingSequenceFlows.size(); i++) &#123;</span><br><span class="line"></span><br><span class="line">                    ExecutionEntity parent = <span class="keyword">execution</span>.getParentId() != <span class="keyword">null</span> ? <span class="keyword">execution</span>.getParent() : <span class="keyword">execution</span>;</span><br><span class="line">                    ExecutionEntity outgoingExecutionEntity = commandContext.getExecutionEntityManager().createChildExecution(parent);</span><br><span class="line"></span><br><span class="line">                    SequenceFlow outgoingSequenceFlow = outgoingSequenceFlows.get(i);</span><br><span class="line">                    outgoingExecutionEntity.setCurrentFlowElement(outgoingSequenceFlow);</span><br><span class="line"></span><br><span class="line">                    executionEntityManager.insert(outgoingExecutionEntity);</span><br><span class="line">                    outgoingExecutions.add(outgoingExecutionEntity);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Leave (only done when all executions have been made, since some queries depend on this) 离开（仅在所有执行完成后才完成，因为某些查询依赖于此）</span></span><br><span class="line">            <span class="keyword">for</span> (ExecutionEntity outgoingExecution : outgoingExecutions) &#123;</span><br><span class="line">                Context.getAgenda().planContinueProcessOperation(outgoingExecution);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>总的来说leaveFlowNode主要是以下4个点</p>
<ol>
<li>获取默认序列流（如果设置）</li>
<li>获取所有出线的表达式并计算（两种情况：未开启跳过则进行表达式计算；1条出线或配置必须跳过条件为true）确定哪些序列流可用于离开。</li>
<li>步骤2结果数为0且需计算条件（则从该节点所有出线里找出默认出线）;</li>
<li>没有发现出线。结束执行。（Context.getAgenda().planEndExecutionOperation(execution节点)）否则：从集合获取第一条线设置active为true。<br>
并对所有出线创建子执行execution,并对所有子执行进行： Context.getAgenda().planContinueProcessOperation(outgoingExecution线)操作。</li>
</ol>
<p>接下来是handleSequenceFlow</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">handleSequenceFlow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 更新结束信息(结束时间、花费时间、删除原因)</span></span><br><span class="line">       commandContext.getHistoryManager().recordActivityEnd(<span class="keyword">execution</span>,<span class="keyword">null</span>);</span><br><span class="line">	<span class="comment">// 执行继续流程计划Context.getAgenda().planContinueProcessOperation(execution);</span></span><br><span class="line">       Context.getAgenda().planContinueProcessOperation(<span class="keyword">execution</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="二、-总结">二、 总结</h2>
<p>分析有点多,总的来说就是</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">检查是否补偿节点，</span><br><span class="line"> 是:</span><br><span class="line">    <span class="number">1</span>.到这里停止执行，做清理操作并返回。</span><br><span class="line"> 否:</span><br><span class="line">    <span class="number">1</span>.离开当前活动时候，要删除任务相关的执行（例如活动边界事件）;</span><br><span class="line">       if. 当是一个父元素而非流程实例时候：则先销毁该元素范围内的，通过：Context<span class="selector-class">.getAgenda</span>()<span class="selector-class">.planDestroyScopeOperation</span>(execution);</span><br><span class="line">       else 若是一个任务节点：更新(ACT_HI_ACTINST表)实例历史数据并删除子执行的相关数据（但不删除定义了边界取消事件的节点）</span><br><span class="line">            删除的子执行的数据有:</span><br><span class="line">                            <span class="number">1</span>.删除ACT_RU_IDENTITYLINK </span><br><span class="line">                            <span class="number">2</span>.删除ACT_RU_VARIABLE </span><br><span class="line">                            <span class="number">3</span>.删除ACT_GE_BYTEARRAY</span><br><span class="line">                            <span class="number">4</span>.删除ACT_RU_EXECUTION</span><br><span class="line">    <span class="number">2</span>.判断节点类型</span><br><span class="line">        若是个节点：执行handleFlowNode操作：</span><br><span class="line">                    a.记录结束时间等信息及监听器的触发</span><br><span class="line">                    b.若是特别子流程：</span><br><span class="line">                           <span class="number">1</span>.如果有完成条件、判断条件是否满足</span><br><span class="line">                           <span class="number">2</span>.若出线大于<span class="number">0</span>则:执行出线<span class="built_in">leaveFlowNode</span>()</span><br><span class="line">                                 出线为<span class="number">0</span>则:执行删除执行相关数据操作(也就是可能是特殊子流程的最后一个节点了)</span><br><span class="line">                           <span class="number">3</span>.若<span class="number">1</span>满足完成条件：</span><br><span class="line">                                    判断：</span><br><span class="line">                                    若特殊子流程不取消剩余实例：                                    </span><br><span class="line">                                       a.判断是否结束特殊子流程: 查找是否还有其他的子执行，若是则不结束;                                    </span><br><span class="line">                                       <span class="selector-tag">b</span>.若结束则:Context.<span class="built_in">getAgenda</span>().<span class="built_in">planEndExecutionOperation</span>(execution.<span class="built_in">getParent</span>()); </span><br><span class="line">                       否则：leaveFlowNode操作：</span><br><span class="line">                                <span class="number">1</span>.获取默认序列流（如果设置）</span><br><span class="line">                                <span class="number">2</span>.获取所有出线的表达式并计算（两种情况：未开启跳过则进行表达式计算；<span class="number">1</span>条出线或配置必须跳过条件为true）</span><br><span class="line">                                <span class="number">3</span>.确定哪些序列流可用于离开。</span><br><span class="line">                                <span class="number">4</span>.步骤<span class="number">2</span>结果数为<span class="number">0</span>且需计算条件（则从该节点所有出线里找出默认出线）;</span><br><span class="line">                                <span class="number">5</span>.没有发现出线。结束执行。（Context<span class="selector-class">.getAgenda</span>()<span class="selector-class">.planEndExecutionOperation</span>(execution节点)）</span><br><span class="line">                                  否则：从集合获取第一条线设置active为true。</span><br><span class="line">                                       并对所有出线创建子执行execution,并对所有子执行进行:Context.<span class="built_in">getAgenda</span>().<span class="built_in">planContinueProcessOperation</span>(outgoingExecution线)操作。   </span><br><span class="line">        若是个线条：执行handleSequenceFlow操作。</span><br><span class="line">                 <span class="number">1</span>.更新结束信息(结束时间、花费时间、删除原因)</span><br><span class="line">                 <span class="number">2</span>.执行继续流程计划Context.<span class="built_in">getAgenda</span>().<span class="built_in">planContinueProcessOperation</span>(execution线);</span><br></pre></td></tr></table></figure>

        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/cn/工作流系列--EndExecutionOperation源码解析/" data-toggle="tooltip" data-placement="top" title="工作流系列--EndExecutionOperation源码解析">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/cn/工作流系列--行为Behavior分析/" data-toggle="tooltip" data-placement="top" title="工作流系列--行为Behavior分析">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      如果您喜欢此博客或发现它对您有用，则欢迎对此发表评论。 也欢迎您共享此博客，以便更多人可以参与。 如果博客中使用的图像侵犯了您的版权，请与作者联系以将其删除。 谢谢 ！
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=工作流系列--TakeOutgoingSequenceFlowsOperation出线分析&body=Hi,I found this website and thought you might like it http://yoursite-url/cn/工作流系列--planTakeOutgoingSequenceFlowsOperation出线分析/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '',
      clientSecret: '',
      repo: '',
      owner: '',
      admin: '',
      id: 'Sat Nov 09 2024 15:14:51 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">目录</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">工作流系列–planTakeOutgoingSequenceFlowsOperation出线分析</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%B8%80%E3%80%81-%E5%88%86%E6%9E%90"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">一、 分析</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%BA%8C%E3%80%81-%E6%80%BB%E7%BB%93"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">二、 总结</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">特色标签</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#笔记" title="笔记">笔记</a>
            
            <a class="tag" href="/tags/#工作流" title="工作流">工作流</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>链友</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://hexo.io/" target="_blank">Hexo</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/zhang-weizhen">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          张伟真
          2025
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://yoursite-url/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="搜索..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
